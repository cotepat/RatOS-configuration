# WARNING. DO NOT EDIT THIS FILE.
# To override settings from this file, you can copy and paste the relevant
# sections into your printer.cfg and change it there.

[save_variables]
filename: ~/printer_data/config/RatOS/printers/v-cast/variables.klip

# Helper script to park the carriage (called from T0 and T1 macros)
[gcode_macro _PARK_EXTRUDER]
gcode:
    {% set extruder = params.EXTRUDER %}
    SAVE_GCODE_STATE NAME=parkextruder
    G90
    {% if extruder == "extruder" %}
      G1 X{printer.configfile.config["stepper_x"].position_min|float + 2} F9000
    {% else %}
      G1 X{printer.configfile.config["dual_carriage"].position_max|float - 2} F9000
    {% endif %}
    RESTORE_GCODE_STATE NAME=parkextruder

# Activate the primary extruder / carriage
[gcode_macro T0]
variable_offset_applied: 0
gcode:
  {% if (printer.toolhead.extruder|lower == "extruder1") %}
    _PARK_EXTRUDER EXTRUDER="extruder1"
    SET_DUAL_CARRIAGE CARRIAGE=0
    ACTIVATE_EXTRUDER EXTRUDER="extruder"

    G1 F9000

    {% if printer["gcode_macro T0"].offset_applied == 1 %}
        {action_respond_info("Removing g-code offsets...")}
        {% set svv = printer.save_variables.variables %}
        SET_GCODE_OFFSET X_ADJUST={ -(svv.xoffset) } Y_ADJUST={ -(svv.yoffset) }
        SET_GCODE_OFFSET Z_ADJUST={ -(svv.zoffset) }
        SET_GCODE_VARIABLE MACRO=T0 VARIABLE=offset_applied VALUE=0
    {% endif %}
    #{% set fan_speed = printer["gcode_macro M106"].swap_speed %}
    #{% if fan_speed != -1 %}
    #  SET_FAN_SPEED FAN=fan_extruder SPEED={fan_speed}
    #  SET_FAN_SPEED FAN=fan_extruder1 SPEED=0
    #{% else %}
      # Update core Klipper's fan speed to the fan speed of the active toolhead
      # Only do this if you have a sacrificial [fan] section
    #  M106.1 S{printer["fan_generic fan_extruder"].speed * 255}
    #{% endif %}
  {% endif %}

# Activate the secondary extruder / carriage
[gcode_macro T1]
gcode:
  {% if (printer.toolhead.extruder|lower == "extruder") %}
    _PARK_EXTRUDER EXTRUDER="extruder"
    SET_DUAL_CARRIAGE CARRIAGE=1
    ACTIVATE_EXTRUDER EXTRUDER="extruder1"

    G1 F9000

    {% if printer["gcode_macro T0"].offset_applied == 0 %}
        {action_respond_info("Applying g-code offsets...")}
        {% set svv = printer.save_variables.variables %}
        SET_GCODE_OFFSET X_ADJUST={ svv.xoffset } Y_ADJUST={ svv.yoffset }
        SET_GCODE_OFFSET Z_ADJUST={ svv.zoffset }
        SET_GCODE_VARIABLE MACRO=T0 VARIABLE=offset_applied VALUE=1
    {% endif %}
    #{% set fan_speed = printer["gcode_macro M106"].swap_speed %}
    #{% if fan_speed != -1 %}
    #  SET_FAN_SPEED FAN=fan_extruder1 SPEED={fan_speed}
    #  SET_FAN_SPEED FAN=fan_extruder SPEED=0
    #{% else %}
      # Update core Klipper's fan speed to the fan speed of the active toolhead
      # Only do this if you have a sacrificial [fan] section
    #  M106.1 S{printer["fan_generic fan_extruder1"].speed * 255}
    #{% endif %}
    #SET_INPUT_SHAPER shaper_freq_x=42.0
  {% endif %}

# Macro to perform a modified MAYBE_HOME supporting t0 and t1 macros
[gcode_macro MAYBE_HOME]
description: Only home unhomed axis
variable_is_kinematic_position_overriden: False
gcode:
  {% if (printer.toolhead.extruder|lower == "extruder1") %}
    SET_DUAL_CARRIAGE CARRIAGE=0
    ACTIVATE_EXTRUDER EXTRUDER="extruder"
  {% endif %}
  {% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
    RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
    G28
    SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
  {% else %}
    {% set axes = '' %}
    {% set isHomed = true %}
    {% set axesToHome = '' %}
    {% if params.X is defined %}
      {% set axes = axes ~ 'X ' %}
      {% if 'x' not in printer.toolhead.homed_axes %}
        {% set isHomed = false %}
        {% set axesToHome = axesToHome ~ 'X ' %}
      {% endif %}
    {% endif %}
    {% if params.Y is defined %}
      {% set axes = axes ~ 'Y ' %}
      {% if 'y' not in printer.toolhead.homed_axes %}
        {% set isHomed = false %}
        {% set axesToHome = axesToHome ~ 'Y ' %}
      {% endif %}
    {% endif %}
    {% if params.Z is defined %}
      {% set axes = axes ~ 'Z ' %}
      {% if 'z' not in printer.toolhead.homed_axes %}
        {% set isHomed = false %}
        {% set axesToHome = axesToHome ~ 'Z ' %}
      {% endif %}
    {% endif %}
    {% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
      {% set axes = '' %}
      {% if 'x' not in printer.toolhead.homed_axes %}
        {% set isHomed = false %}
        {% set axesToHome = axesToHome ~ 'X ' %}
      {% endif %}
      {% if 'y' not in printer.toolhead.homed_axes %}
        {% set isHomed = false %}
        {% set axesToHome = axesToHome ~ 'Y ' %}
      {% endif %}
      {% if 'z' not in printer.toolhead.homed_axes %}
        {% set isHomed = false %}
        {% set axesToHome = axesToHome ~ 'Z ' %}
      {% endif %}
    {% endif %}
    {% if isHomed is false %}
      M117 Homing {axesToHome}
      RESPOND MSG="Homing {axesToHome}"
      G28 {axesToHome}
    {% else %}
      RESPOND MSG="All requested axes already homed, skipping.."
    {% endif %}
  {% endif %}
